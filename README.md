# bgmon


## アクション
- サイトディスカバリ：対象のノードを発見する方法。とりあえず直近ではやるつもりはなくて固定的なインベントリとして管理する。
- ディテクトステート：アクティブ/ステージングサイトの検出および各サイトのデプロイバージョンの確認、ステートバージョンの確認
- ステージングデプロイ：ステージングサイトにしかデプロイできない仕組み
- ステートマイグレーション：ステート情報（短絡的にはDB）をアクティブサイトからステージングサイトへ同期する
- サイトスイッチ：アクティブ/ステージングサイトの切り替え

### ディテクトステート

現在の状態を把握するための機能。主に他のアクション系機能の実行を判断するための情報をそろえるのが目的。  
サイトレベルだとアクティブサイト検出  
ステートレスレイヤーだと各サイトのデプロイアプリバージョン  
パーシステントレイヤーだと各データベースの更新日時とか更新ログの位置とか差分が分かる情報  

#### アクティブサイト検出(detectSiteState)
検出サイトのうち現在公開中のアクティブなサイトID群を返す。

実装案１：VirtualIPを持ちまわすタイプの切り替え方式に対する検出方式
　同一セグメントにいるならarp(`ip n`)かな。サービスIPと各サイトのip or MACを覚えておく.
実装案２：DNS名の解決先変更によって切り替えるタイプに対する検出方式
　サービス用のホスト名を解決してipアドレスがマッチするサイトを探す
　
#### デプロイアプリバージョン(getDeployedAppVer)
引数で指定したサイトIDにデプロイされているアプリケーションバージョン/ビルドID/日時などの固有情報を取得する。  
アプリ内に埋め込まれたバージョン情報を取得するイメージ。各サイトの特定URLにアクセスして取得する

#### ステートバージョン(getPersistentState)
引数で指定したサイトIDの永続化バージョンを取得する。ステートマイグレの必要性を確認するための情報。   
優先度は少し下げておく。  

例１）MYSQLでの更新ログ(binlog)のポジションデータ`show master status`
例２）MYSQLのスキーマデータデータ更新日時`SHOW TABLE STATUS`での更新日時。innodbだといつもnullといううわさが・・・(https://bugs.mysql.com/bug.php?id=14374)

#### 最新アプリバージョン(getLatestAppVer)
次のデプロイで適用されるアプリバージョンやビルドIDなどの固有情報を取得する。
基本的には別途管理されているgitやjenkinsを想定。


## レイヤー
- ステートレスレイヤー：アプリのコードなどの部分。基本デプロイ時に使い捨て。Immutable Infraを実践するエリア。
- パーシステントレイヤー：アプリとしてステートを保持する部分。どのように移行するかが課題。スキーママイグレ＆データマイグレ。
